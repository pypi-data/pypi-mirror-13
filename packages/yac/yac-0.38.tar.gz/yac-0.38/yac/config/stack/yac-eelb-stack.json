{
  "Parameters" : {
    "ExternalElbName" : {
      "Description" : "The name of the External ELB",
      "Type"        : "String"
    }
  },
  "Resources" : {
    "ExternalElb" : {
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : {
        "AccessLoggingPolicy" : {
          "EmitInterval" : 5,
          "Enabled": true,
          "S3BucketName": {"Ref" : "S3Bucket"},
          "S3BucketPrefix" : { "Ref" : "AccessLogsPath" }
        },
        "SecurityGroups": [ { "Fn::GetAtt": ["ExternalElbSG", "GroupId" ]} ],
        "LoadBalancerName" : { "Ref" : "ExternalElbName" },
        "Listeners" : [ 
          {
            "LoadBalancerPort" : "443",
            "InstancePort" : { "Ref" : "WebServerPort" },
            "InstanceProtocol": "HTTPS",
            "Protocol" : "HTTPS",
            "SSLCertificateId": {
              "Fn::Join":["",[
                "arn:aws:iam::",{"Ref":"AWS::AccountId"},
                ":server-certificate","/",
                { "Ref": "SSLCert" }]]
            }
          }
        ],
        "HealthCheck" : {
          "Target" : { "Fn::Join" : [ "", ["HTTP:81",{"Ref" : "HealthCheckPath" }]]},
          "HealthyThreshold" : "3",
          "UnhealthyThreshold" : "5",
          "Interval" : "20",
          "Timeout" : "5"
        },
        "Scheme": "internet-facing",
        "Subnets": {"Ref" : "PublicSubnets"},
        "Tags" : [ 
          { "Key": "Name", "Value" : { "Ref" : "ExternalElbName" } },
          { "Key": "Owner", "Value": { "Ref": "Owner" } },
          { "Key": "CostCenter", "Value": { "Ref": "CostCenter" } }]
      }
    },    
    "ExternalElbSG" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "Properties" : {
        "GroupDescription" : "Enable inbound HTTPS access for web clients",
        "SecurityGroupIngress" : [ 
          {
            "IpProtocol" : "tcp",
            "FromPort" : "443",
            "ToPort" : "443",
            "CidrIp" : "0.0.0.0/0"
          }
         ],        
        "VpcId": {"Ref" : "VpcId"},
        "Tags" : [ 
          { "Key": "Name", "Value" : {  "Fn::Join" : ["-", [ { "Ref" : "ExternalElbName" }, "SG"]] }},
          { "Key": "Owner", "Value": { "Ref": "Owner" } },
          { "Key": "CostCenter", "Value": { "Ref": "CostCenter" } } ]
      }
    },      
    "ExternalElbHttpEgress" : {
      "Type" : "AWS::EC2::SecurityGroupEgress",
      "Properties" : {
        "GroupId" : { "Fn::GetAtt": ["ExternalElbSG","GroupId"]},
        "IpProtocol" : "tcp",
        "FromPort" : { "Ref" : "WebServerPort" },
        "ToPort" : { "Ref" : "DebugPort" },
        "DestinationSecurityGroupId" : {"Fn::GetAtt": ["AppSG","GroupId"]}
      }
    },  
    "ExternalElbHttpIngress" : {
      "Type" : "AWS::EC2::SecurityGroupIngress",
      "Properties" : {
        "GroupId" : { "Fn::GetAtt": ["AppSG","GroupId"]},
        "IpProtocol" : "tcp",
        "FromPort" : { "Ref" : "WebServerPort" },
        "ToPort" : { "Ref" : "DebugPort" },
        "SourceSecurityGroupId" : { "Fn::GetAtt": ["ExternalElbSG","GroupId"] }
      }
    }    
  }
}