(function(){!function($){$.fn.datagrid=function(options){function setupHeader(){var $origHeader=$bodyTable.find("thead");$bodyTable.find("colgroup col").each(function(i,colEl){storedColWidths.push(colEl.width)}),$headTable.find("thead").remove().end().append($origHeader.clone().show()),$origHeader.hide(),activeColumns=[],$headTable.find("col").not(".datagrid-customize").each(function(i,col){activeColumns.push(col.className)}),$headTable.find("th").disableSelection().not(".edit-columns").draggable({appendTo:"body",axis:"x",containment:$headTable.find("thead:first"),cursor:"move",helper:function(){var $el=$(this);return $("<div/>").addClass("datagrid-header-drag datagrid-header").width($el.width()).height($el.height()).css("top",$el.offset().top).html($el.html())},start:startColumnDrag,stop:endColumnDrag,drag:onColumnDrag}),$editButton=$("#"+gridId+"-edit").click(function(evt){evt.stopPropagation(),toggleColumnsMenu()}),$headTable.find(".datagrid-header-checkbox").change(function(){var $checkbox=$(this),colName=$checkbox.data("checkbox-name");$bodyTable.find('tbody input[data-checkbox-name="'+colName+'"]').prop("checked",$checkbox.prop("checked")).change()})}function syncColumnSizes(){var width,i,origHeaderCells=$bodyTableHead[0].rows[0].cells,$fixedCols=$headTable.find("colgroup col"),$origCols=$bodyTable.find("colgroup col"),numCols=origHeaderCells.length,bodyWidths=[],headWidths=[],extraWidth=0;for(i=0;numCols>i;i++)$origCols[i].width=storedColWidths[i];for($bodyTableHead.show(),$headTable.width($bodyContainer.width()-1),extraWidth=$bodyContainer.width()-$bodyTable.width(),i=0;numCols>i;i++)width=$(origHeaderCells[i]).outerWidth(),bodyWidths.push(width),headWidths.push(width);for($bodyTableHead.hide(),headWidths[numCols-1]=bodyWidths[numCols-1]-1,headWidths[numCols-2]=bodyWidths[numCols-2]-1+extraWidth,i=0;numCols>i;i++)$origCols[i].width=bodyWidths[i],$fixedCols[i].width=headWidths[i]}function onResize(){var windowWidth=$window.width();windowWidth!==lastWindowWidth&&(lastWindowWidth=windowWidth,syncColumnSizes())}function loadFromServer(params,reloadGrid){var search=window.location.search||"?",url=window.location.pathname+search+"&gridonly=1&datagrid-id="+gridId;params&&(url+="&"+params),$.get(url,function(html){reloadGrid?($grid.replaceWith(html),$grid=$("#"+gridId).datagrid()):setupHeader(),$grid.trigger("reloaded")})}function hideColumnsMenu(){null!==$activeMenu&&($activeMenu.hide(),$activeMenu=null)}function toggleColumnsMenu(){var offset;$menu.is(":visible")?hideColumnsMenu():(offset=$editButton.position(),$menu.css({left:offset.left-$menu.outerWidth()+$editButton.outerWidth(),top:offset.top+$editButton.outerHeight()}).show(),$activeMenu=$menu)}function saveColumns(columnsStr,reloadGrid){loadFromServer("columns="+columnsStr,reloadGrid)}function toggleColumn(columnId){saveColumns(serializeColumns(columnId),!0)}function serializeColumns(addedColumn){var columnsStr="";return $(activeColumns).each(function(i){var curColumn=activeColumns[i];curColumn===addedColumn?addedColumn=null:(columnsStr+=curColumn,i<activeColumns.length-1&&(columnsStr+=","))}),addedColumn&&(columnsStr+=","+addedColumn),columnsStr}function startColumnDrag(evt,ui){dragColumn=this,dragColumnsChanged=!1,dragColumnWidth=ui.helper.width(),dragIndex=0,dragLastX=0,buildColumnInfo(),$(dragColumn).css("visibility","hidden")}function endColumnDrag(){var $column=$(this);$column.css("visibility","visible"),columnMidpoints=[],dragColumnsChanged&&saveColumns(serializeColumns())}function onColumnDrag(e,ui){var x=e.originalEvent.pageX,hitX=-1,index=-1;x!==dragLastX&&(dragLastX>x?(index=dragIndex-1,hitX=ui.offset.left):(index=dragIndex+1,hitX=ui.offset.left+ui.helper.width()),index>=0&&index<columnMidpoints.length&&(dragLastX>x&&hitX<=columnMidpoints[index]?swapColumnBefore(dragIndex,index):x>dragLastX&&hitX>=columnMidpoints[index]&&swapColumnBefore(index,dragIndex)),dragLastX=x)}function buildColumnInfo(){columnMidpoints=[],$headTable.find("th").not(".edit-columns").each(function(i,column){var $column=$(column),offset=$column.offset();column===dragColumn?(dragIndex=i,width=dragColumnWidth):width=$column.width(),columnMidpoints.push(Math.round(offset.left+width/2))})}function swapColumnBefore(index,beforeIndex){var temp;temp=activeColumns[index],activeColumns[index]=activeColumns[beforeIndex],activeColumns[beforeIndex]=temp,swapColumns($bodyTable[0],beforeIndex,index),swapColumns($headTable[0],beforeIndex,index),temp=storedColWidths[index],storedColWidths[index]=storedColWidths[beforeIndex],storedColWidths[beforeIndex]=temp,dragColumnsChanged=!0,buildColumnInfo()}function swapColumns(table,beforeIndex,index){var beforeCell,tempColSpan,row,cell,rowsLen,i,colTags=$(table).find("colgroup col");for(colTags.eq(index).insertBefore(colTags.eq(beforeIndex)),i=0,rowsLen=table.rows.length;rowsLen>i;i++)row=table.rows[i],cell=row.cells[index],beforeCell=row.cells[beforeIndex],row.insertBefore(cell,beforeCell),tempColSpan=cell.colSpan,cell.colSpan=beforeCell.colSpan,beforeCell.colSpan=tempColSpan}var $editButton,lastWindowWidth,$grid=this,gridId=this.attr("id"),$menu=$("#"+gridId+"-menu"),$gridContainer=$grid.find(".datagrid"),$bodyContainer=$gridContainer.find(".datagrid-body-container"),$headTable=$gridContainer.find(".datagrid-head"),$bodyTable=$bodyContainer.find(".datagrid-body"),$bodyTableHead=$bodyTable.find("thead"),$paginator=$gridContainer.find(".paginator"),$window=$(window),storedColWidths=[],activeColumns=[],$activeMenu=null,columnMidpoints=[],dragColumn=null,dragColumnsChanged=!1,dragColumnWidth=0,dragIndex=0,dragLastX=0;return options=options||{},this.reload=function(){loadFromServer(null,!0)},this.resizeToFit=function(){$bodyContainer.height($grid.innerHeight()-$bodyContainer.position().top-($paginator.outerHeight()||0)),syncColumnSizes()},$grid.data("datagrid",this),setupHeader(),$menu.find("tr").each(function(i,row){var className=row.className;$(row).find(".datagrid-menu-checkbox, .datagrid-menu-label a").click(function(){toggleColumn(className)})}),$(document.body).click(hideColumnsMenu),$window.resize(onResize),onResize(),$grid},$(document).ready(function(){$("div.datagrid-wrapper").datagrid()})}(jQuery)}).call(this);