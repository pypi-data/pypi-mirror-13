(function(){function updateFormDisplay(id,tools_info){var field,i,type=$("#id_"+id)[0].value,oldInfo=tools_info[prevTypes[id]],newInfo=tools_info[type];for(i=0;i<oldInfo.fields.length;i++)$("#row-"+oldInfo.fields[i]).hide();for(field in oldInfo.help_text)$("#row-"+field).find("p.help").remove();for(i=0;i<newInfo.fields.length;i++)$("#row-"+newInfo.fields[i]).show();for(field in newInfo.help_text){var text=newInfo.help_text[field];$("#row-"+field).append($('<p class="help"/>').text(text))}prevTypes[id]=type}function updatePlanEl(rowEl,planEl,serviceType){var i,planTypes=HOSTING_SERVICES[serviceType].plans,selectedPlan=planEl.val();if(planEl.empty(),1===planTypes.length)rowEl.hide();else{for(i=0;i<planTypes.length;i++){var planType=planTypes[i],opt=$("<option/>").val(planType.type).text(planType.label).appendTo(planEl);planType.type===selectedPlan&&opt.attr("selected","selected")}rowEl.show()}planEl.triggerHandler("change")}function updateHostingForm(hostingTypeEl,formPrefix,planEl,formsEl){var formID=formPrefix+"-"+hostingTypeEl[0].value+"-"+(planEl.val()||"default");formsEl.hide(),$("#"+formID).show()}function hideAllToolsFields(){var fields=TOOLS_INFO.none.fields;for(i=0;i<fields.length;i++)$("#row-"+fields[i]).hide()}function updateRepositoryType(){var hostingType=$("#id_hosting_type")[0].value,newRepoTypes="custom"===hostingType?[]:HOSTING_SERVICES[hostingType].scmtools,repoTypesEl=$("#id_tool"),currentRepoType=repoTypesEl[0].value;repoTypesEl.empty(),$(origRepoTypes).each(function(i){var repoType=origRepoTypes[i];(0===newRepoTypes.length||-1!==$.inArray(repoType.text,newRepoTypes))&&($("<option/>").text(repoType.text).val(repoType.value).appendTo(repoTypesEl),repoType.value===currentRepoType&&(repoTypesEl[0].value=currentRepoType))}),repoTypesEl.triggerHandler("change")}var prevTypes={},origRepoTypes=[];$(document).ready(function(){var hostingTypeEl=$("#id_hosting_type"),hostingURLRowEl=$("#row-hosting_url"),hostingURLEl=$("#id_hosting_url"),hostingAccountEl=$("#id_hosting_account"),hostingAccountRowEl=$("#row-hosting_account"),hostingAccountUserRowEl=$("#row-hosting_account_username"),hostingAccountPassRowEl=$("#row-hosting_account_password"),hostingAccountTwoFactorAuthCodeRowEl=$("#row-hosting_account_two_factor_auth_code"),hostingAccountRelinkEl=$("<p/>").text("The authentication requirements for this account has changed. You will need to re-authenticate.").addClass("errornote").hide().appendTo(hostingAccountRowEl),associateSshKeyFieldsetEl=$("#row-associate_ssh_key").parent("fieldset"),associateSshKeyEl=$("#id_associate_ssh_key"),associateSshKeyElDisabled=associateSshKeyEl[0].disabled,bugTrackerUseHostingEl=$("#id_bug_tracker_use_hosting"),bugTrackerTypeEl=$("#id_bug_tracker_type"),bugTrackerHostingURLRowEl=$("#row-bug_tracker_hosting_url"),bugTrackerTypeRowEl=$("#row-bug_tracker_type"),bugTrackerPlanEl=$("#id_bug_tracker_plan"),bugTrackerPlanRowEl=$("#row-bug_tracker_plan"),bugTrackerURLRowEl=$("#row-bug_tracker"),bugTrackerUsernameRowEl=$("#row-bug_tracker_hosting_account_username"),repoPathRowEl=$("#row-path"),repoMirrorPathRowEl=$("#row-mirror_path"),repoPlanRowEl=$("#row-repository_plan"),repoPlanEl=$("#id_repository_plan"),publicAccessEl=$("#id_public"),toolEl=$("#id_tool"),publicKeyPopup=$("#ssh-public-key-popup"),repoForms=$(".repo-form"),bugTrackerForms=$(".bug-tracker-form");prevTypes.bug_tracker_type="none",prevTypes.hosting_type="custom",prevTypes.tool="none",toolEl.find("option").each(function(){origRepoTypes.push({value:$(this).val(),text:$(this).text()})}),bugTrackerUseHostingEl.change(function(){this.checked;this.checked?(bugTrackerTypeRowEl.hide(),bugTrackerPlanRowEl.hide(),bugTrackerUsernameRowEl.hide(),bugTrackerURLRowEl.hide(),bugTrackerForms.hide()):(bugTrackerTypeRowEl.show(),bugTrackerTypeEl.triggerHandler("change"))}).triggerHandler("change"),repoPlanEl.change(function(){updateHostingForm(hostingTypeEl,"repo-form",repoPlanEl,repoForms)}),bugTrackerPlanEl.change(function(){var plan=bugTrackerPlanEl.val()||"default",bugTrackerType=bugTrackerTypeEl.val(),planInfo=HOSTING_SERVICES[bugTrackerType].planInfo[plan];updateHostingForm(bugTrackerTypeEl,"bug-tracker-form",bugTrackerPlanEl,bugTrackerForms),planInfo.bug_tracker_requires_username?bugTrackerUsernameRowEl.show():bugTrackerUsernameRowEl.hide()}),hostingTypeEl.change(function(){var hostingType=hostingTypeEl[0].value,isCustom="custom"===hostingType;updateRepositoryType(),isCustom?(repoPlanRowEl.hide(),repoPathRowEl.show(),repoMirrorPathRowEl.show()):(hideAllToolsFields(),repoPathRowEl.hide(),repoMirrorPathRowEl.hide(),updatePlanEl(repoPlanRowEl,repoPlanEl,hostingType)),repoPlanEl.triggerHandler("change"),isCustom||!HOSTING_SERVICES[hostingType].supports_bug_trackers?(bugTrackerUseHostingEl[0].disabled=!0,bugTrackerUseHostingEl[0].checked=!1,bugTrackerUseHostingEl.triggerHandler("change")):bugTrackerUseHostingEl[0].disabled=!1,isCustom||!HOSTING_SERVICES[hostingType].supports_ssh_key_association?(associateSshKeyFieldsetEl.hide(),associateSshKeyEl[0].disabled=!0,associateSshKeyEl[0].checked=!1):(associateSshKeyEl[0].disabled=associateSshKeyElDisabled,associateSshKeyFieldsetEl.show()),isCustom||!HOSTING_SERVICES[hostingType].self_hosted?hostingURLRowEl.hide():hostingURLRowEl.show()}).triggerHandler("change"),$([hostingTypeEl[0],hostingURLEl[0]]).change(function(){var hostingType=hostingTypeEl[0].value;if("custom"!==hostingType){var selectedAccount,i,hostingInfo=HOSTING_SERVICES[hostingType],accounts=hostingInfo.accounts,foundSelected=!1;for(selectedAccount=parseInt(hostingAccountEl.val(),10),selectedURL=hostingURLEl.val()||null,hostingAccountEl.find('option[value!=""]').remove(),hostingInfo.needs_two_factor_auth_code&&(foundSelected=!0),i=0;i<accounts.length;i++){var account=accounts[i];if(account.hosting_url===selectedURL){var opt=$("<option/>").val(account.pk).text(account.username).data("account",account).appendTo(hostingAccountEl);account.pk!==selectedAccount&&foundSelected||(opt.attr("selected","selected"),foundSelected=!0,hostingAccountEl.triggerHandler("change"))}}}}),$([hostingTypeEl[0],hostingAccountEl[0]]).change(function(){var hostingInfo,hostingType=hostingTypeEl.val();if(hostingAccountRelinkEl.hide(),hostingAccountTwoFactorAuthCodeRowEl.hide(),"custom"===hostingType)hostingAccountRowEl.hide(),hostingURLRowEl.hide(),hostingAccountUserRowEl.hide(),hostingAccountPassRowEl.hide();else if(hostingInfo=HOSTING_SERVICES[hostingType],hostingAccountRowEl.show(),hostingInfo.self_hosted&&hostingURLRowEl.show(),""===hostingAccountEl.val())hostingAccountUserRowEl.show(),hostingInfo.needs_authorization?hostingAccountPassRowEl.show():hostingAccountPassRowEl.hide(),hostingInfo.needs_two_factor_auth_code&&hostingAccountTwoFactorAuthCodeRowEl.show();else{var selectedOption=$(hostingAccountEl[0].options[hostingAccountEl[0].selectedIndex]),account=selectedOption.data("account");hostingAccountUserRowEl.hide(),account.is_authorized?hostingAccountPassRowEl.hide():(hostingAccountPassRowEl.show(),hostingAccountRelinkEl.show())}}).triggerHandler("change"),toolEl.change(function(){"custom"===hostingTypeEl[0].value?updateFormDisplay("tool",TOOLS_INFO):hideAllToolsFields()}).triggerHandler("change"),bugTrackerTypeEl.change(function(){var bugTrackerType=bugTrackerTypeEl[0].value;bugTrackerForms.hide(),("custom"===bugTrackerType||"none"===bugTrackerType)&&(bugTrackerHostingURLRowEl.hide(),bugTrackerPlanRowEl.hide(),bugTrackerUsernameRowEl.hide()),"custom"===bugTrackerType?bugTrackerURLRowEl.show():"none"===bugTrackerType?bugTrackerURLRowEl.hide():(bugTrackerURLRowEl.hide(),updatePlanEl(bugTrackerPlanRowEl,bugTrackerPlanEl,bugTrackerType),HOSTING_SERVICES[bugTrackerType].self_hosted?bugTrackerHostingURLRowEl.show():bugTrackerHostingURLRowEl.hide())}).triggerHandler("change"),publicAccessEl.change(function(){this.checked?($("#row-users").hide(),$("#row-review_groups").hide()):($("#row-users").show(),$("#row-review_groups").show())}).triggerHandler("change"),$("#show-ssh-key-link").toggle(function(){return $(this).text("Hide SSH Public Key"),publicKeyPopup.show(),!1},function(){return $(this).text("Show SSH Public Key"),publicKeyPopup.hide(),!1})})}).call(this);