(function(){function registerToggleStar(){var STAR_ON_IMG=STATIC_URLS["rb/images/star_on.png"],STAR_OFF_IMG=STATIC_URLS["rb/images/star_off.png"];$(document).on("click",".star",function(){var self=$(this),obj=self.data("rb.obj");if(!obj){var type=self.attr("data-object-type"),objid=self.attr("data-object-id");if("reviewrequests"==type)obj=new RB.ReviewRequest(objid);else{if("groups"!=type)return void self.remove();obj=new RB.ReviewGroup(objid)}}var on=1==parseInt(self.attr("data-starred"),10)?0:1;obj.setStarred(on),self.data("rb.obj",obj);var alt_title=on?"Starred":"Click to star";self.attr({src:on?STAR_ON_IMG:STAR_OFF_IMG,"data-starred":on,alt:alt_title,title:alt_title})})}function sendFileBlob(file,save_func,obj,options){var reader=new FileReader;reader.onloadend=function(){var boundary="-----multipartformboundary"+(new Date).getTime(),blob="";blob+="--"+boundary+"\r\n",blob+='Content-Disposition: form-data; name="path"; filename="'+file.name+'"\r\n',blob+="Content-Type: "+file.type+"\r\n",blob+="\r\n",blob+=reader.result,blob+="\r\n",blob+="--"+boundary+"--\r\n",blob+="\r\n",save_func.call(obj,options.success,options.error,{buttons:options.buttons,data:blob,processData:!1,contentType:"multipart/form-data; boundary="+boundary,xhr:function(){var xhr=$.ajaxSettings.xhr();return xhr.send=function(data){xhr.sendAsBinary(data)},xhr}})},reader.readAsBinaryString(file)}var once=function(evt,callback,context){var cb=_.bind(function(){this.off(evt,cb),callback.apply(context||this,arguments)},this);this.on(evt,cb)};Backbone.Events.once=once,Backbone.Model.prototype.once=once,Backbone.Collection.prototype.once=once,Backbone.View.prototype.once=once;var _origAssert;"undefined"==typeof window.console&&(window.console={}),_origAssert=console.assert,"undefined"==typeof console.log&&(console.log=function(){}),"undefined"==typeof console.warn&&(console.warn=function(){}),console.assert=function(conditional,msg){if(_origAssert&&_origAssert.call&&_origAssert.call(console,conditional,msg),!conditional)throw Error(msg)},$.fn.bindProperty=function(elPropName,model,modelPropName,options){function updateElementProp(){var value=model.get(modelPropName);options.inverse&&(value=!value),$this.prop(elPropName)!==value&&$this.prop(elPropName,value)}var $this=$(this);return options=_.defaults(options||{},{modelToElement:!0,elementToModel:!0,inverse:!1}),options.modelToElement&&(model.on("change:"+modelPropName,updateElementProp),updateElementProp()),options.elementToModel&&$this.on("change",function(value){var value=$this.prop(elPropName);options.inverse&&(value=!value),model.set(modelPropName,value)}),$this},$.fn.bindVisibility=function(model,modelPropName,options){function updateVisibility(){var value=model.get(modelPropName);options&&options.inverse&&(value=!value),$this.setVisible(value)}var $this=$(this);return model.on("change:"+modelPropName,updateVisibility),updateVisibility(),$this},RB={},$.fn.formDlg=function(options){return options=$.extend({action:".",confirmLabel:"Send",fields:{},dataStoreObject:null,success:function(){window.location.reload()},title:"",upload:!1,width:null},options),this.each(function(){function send(){options.dataStoreObject.setForm(form),options.dataStoreObject.save({buttons:$("input:button",box.modalBox("buttons")),success:function(rsp){options.success(rsp),box.remove()},error:function(rsp){displayErrors(rsp)}})}function displayErrors(rsp){var errorStr=rsp.err.msg;if(options.dataStoreObject.getErrorString&&(errorStr=options.dataStoreObject.getErrorString(rsp)),errors.html(errorStr).show(),rsp.fields)for(var fieldName in rsp.fields)if(fieldInfo[fieldName])for(var list=$(".errorlist",fieldInfo[fieldName].row).css("display","block"),i=0;i<rsp.fields[fieldName].length;i++)$("<li/>").appendTo(list).html(rsp.fields[fieldName][i])}var self=$(this),errors=$("<div/>").addClass("error").hide(),form=$("<form/>").attr("action",options.action).submit(function(){return send(),!1}).append($("<table/>").append($("<colgroup/>").append("<col/>").append("<col/>").append('<col width="100%"/>')).append($("<tbody/>")));options.upload&&form.attr({encoding:"multipart/form-data",enctype:"multipart/form-data"});for(var tbody=$("tbody",form),fieldInfo={},i=0;i<options.fields.length;i++){var field=options.fields[i];fieldInfo[field.name]={field:field},field.hidden?form.append($(field.widget)):(fieldInfo[field.name].row=$("<tr/>").appendTo(tbody).append($("<td/>").addClass("label").html(field.label)).append($("<td/>").html(field.widget)).append($("<td/>").append($("<ul/>").addClass("errorlist").hide())),field.required&&$("label",fieldInfo[field.name].row).addClass("required"),field.help_text&&$("<tr/>").appendTo(tbody).append("<td/>").append($("<td/>").addClass("help").attr("colspan",2).text(field.help_text)))}var box=$("<div/>").addClass("formdlg").append(errors).append(self).append(form).keypress(function(e){e.stopPropagation()});options.width&&box.width(options.width),box.modalBox({title:options.title,buttons:[$('<input type="button"/>').val("Cancel"),$('<input type="button"/>').val(options.confirmLabel).click(function(){return form.submit(),!1})]})})};var SUMMARY_TRIM_LEN=28;$.fn.searchAutoComplete=function(){this.rbautocomplete({formatItem:function(data){var s;return data.username?(s=data.username,data.fullname&&(s+=" <span>("+_.escape(data.fullname)+")</span>")):data.name?(s=data.name,s+=" <span>("+_.escape(data.display_name)+")</span>"):data.summary&&(s=data.summary.length<SUMMARY_TRIM_LEN?data.summary:data.summary.substring(0,SUMMARY_TRIM_LEN),s+=" <span>("+_.escape(data.id)+")</span>"),s},matchCase:!1,multiple:!0,clickToURL:!0,selectFirst:!1,width:240,parse:function(data){for(var items,jsonData=data,jsonDataSearch=jsonData.search,parsed=[],objects=["users","groups","review_requests"],values=["username","name","summary"],j=0;j<objects.length;j++){items=jsonDataSearch[objects[j]];for(var i=0;i<items.length;i++){var value=items[i];2!=j?parsed.push({data:value,value:value[values[j]],result:value[values[j]]}):value["public"]&&(value.url=SITE_ROOT+"r/"+value.id,parsed.push({data:value,value:value[values[j]],result:value[values[j]]}))}}return parsed},url:SITE_ROOT+"api/search/"})};var gUserInfoBoxCache={};$.fn.user_infobox=function(){var POPUP_DELAY_MS=1e3,OFFSET_LEFT=-20,OFFSET_TOP=-30,infobox=$("#user-infobox");return 0==infobox.length&&(infobox=$("<div id='user-infobox'/>'").hide(),$(document.body).append(infobox)),this.each(function(){var self=$(this),timeout=null,url=self.attr("href")+"infobox/";self.hover(function(){timeout=setTimeout(function(){gUserInfoBoxCache[url]?(infobox.html(gUserInfoBoxCache[url]),infobox.find(".gravatar").retinaGravatar()):infobox.empty().addClass("loading").load(url,function(responseText){gUserInfoBoxCache[url]=responseText,infobox.removeClass("loading"),infobox.find(".gravatar").retinaGravatar()});var offset=self.offset();infobox.move(offset.left+OFFSET_LEFT,offset.top-infobox.height()+OFFSET_TOP,"absolute").show()},POPUP_DELAY_MS)},function(){clearTimeout(timeout),infobox.hide()})})},$(document).ready(function(){$('<div id="activity-indicator" />').text("Loading...").hide().appendTo("body"),$("#search_field").searchAutoComplete(),$(".user").user_infobox(),$("time.timesince").timesince(),$(".gravatar").retinaGravatar(),registerToggleStar()}),RB.DiffComment=function(review,id,filediff,interfilediff,beginLineNum,endLineNum){return this.id=id,this.review=review,this.filediff=filediff,this.interfilediff=interfilediff,this.beginLineNum=beginLineNum,this.endLineNum=endLineNum,this.text="",this.issue_opened=!0,this.issue_status="",this.loaded=!1,this.url=null,this},$.extend(RB.DiffComment.prototype,{ready:function(on_ready){this.loaded?on_ready.apply(this,arguments):this._load(on_ready)},setText:function(text){this.text=text,$.event.trigger("textChanged",null,this)},getNumLines:function(){return this.endLineNum-this.beginLineNum+1},save:function(options){var self=this;options=options||{},self.ready(function(){self.review.ensureCreated(function(){var url,type="POST",data={text:self.text,issue_opened:self.issue_opened,first_line:self.beginLineNum,num_lines:self.getNumLines()};self.loaded?(type="PUT",url=self.url,self.review["public"]&&(data.issue_status=self.issue_status)):(data.filediff_id=self.filediff.id,url=self.review.links.diff_comments.href,self.interfilediff&&(data.interfilediff_id=self.interfilediff.id)),RB.apiCall({type:type,url:url,data:data,success:function(rsp){self._loadDataFromResponse(rsp),$.event.trigger("saved",null,self),$.isFunction(options.success)&&options.success(rsp)}})})})},deleteComment:function(){var self=this;self.ready(function(){self.loaded?RB.apiCall({type:"DELETE",url:self.url,success:function(){$.event.trigger("deleted",null,self),self._deleteAndDestruct()}}):self._deleteAndDestruct()})},deleteIfEmpty:function(){""==this.text&&this.deleteComment()},_deleteAndDestruct:function(){$.event.trigger("destroyed",null,this)},_load:function(on_done){var self=this;return self.id?void self.review.ready(function(){return self.review.loaded?void RB.apiCall({type:"GET",url:self.review.links.diff_comments.href+self.id+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}}):void on_done.apply(this,arguments)}):void on_done.apply(this,arguments)},_loadDataFromResponse:function(rsp){this.id=rsp.diff_comment.id,this.text=rsp.diff_comment.text,this.beginLineNum=rsp.diff_comment.first_line,this.endLineNum=rsp.diff_comment.num_lines+this.beginLineNum-1,this.links=rsp.diff_comment.links,this.url=rsp.diff_comment.links.self.href,this.loaded=!0,this.issue_opened=rsp.diff_comment.issue_opened,this.issue_status=rsp.diff_comment.issue_status}}),RB.DiffCommentReply=function(reply,id,reply_to_id){return this.id=id,this.reply=reply,this.text="",this.reply_to_id=reply_to_id,this.loaded=!1,this.url=null,this},$.extend(RB.DiffCommentReply.prototype,{ready:function(on_ready){this.loaded?on_ready.apply(this,arguments):this._load(on_ready)},setText:function(text){this.text=text,$.event.trigger("textChanged",null,this)},save:function(options){var self=this;options=options||{},self.ready(function(){self.reply.ensureCreated(function(){var type,url,data={text:self.text};self.loaded?(type="PUT",url=self.url):(data.reply_to_id=self.reply_to_id,url=self.reply.links.diff_comments.href),RB.apiCall({type:type,url:url,data:data,success:function(rsp){self._loadDataFromResponse(rsp),$.event.trigger("saved",null,self),$.isFunction(options.success)&&options.success()}})})})},deleteComment:function(){var self=this;self.ready(function(){self.loaded?RB.apiCall({type:"DELETE",url:self.url,success:function(){$.event.trigger("deleted",null,self),self._deleteAndDestruct()}}):self._deleteAndDestruct()})},deleteIfEmpty:function(){""==this.text&&this.deleteComment()},_deleteAndDestruct:function(){$.event.trigger("destroyed",null,this)},_load:function(on_done){var self=this;return self.id?void self.reply.ready(function(){return self.reply.loaded?void RB.apiCall({type:"GET",url:self.reply.links.diff_comments.href+self.id+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}}):void on_done.apply(this,arguments)}):void on_done.apply(this,arguments)},_loadDataFromResponse:function(rsp){this.id=rsp.diff_comment.id,this.text=rsp.diff_comment.text,this.links=rsp.diff_comment.links,this.url=rsp.diff_comment.links.self.href,this.loaded=!0}}),RB.Diff=function(review_request,revision,interdiff_revision){return this.review_request=review_request,this.revision=revision,this.interdiff_revision=interdiff_revision,this},$.extend(RB.Diff.prototype,{getDiffFragment:function(review_base_url,fileid,filediff_id,revision,interdiff_revision,file_index,chunk_index,lines_of_context,onSuccess){var revisionStr=revision,data={index:file_index};null!==interdiff_revision&&(revisionStr+="-"+interdiff_revision),null!==lines_of_context&&(data["lines-of-context"]=lines_of_context),RB.apiCall({url:review_base_url+"diff/"+revisionStr+"/fragment/"+filediff_id+"/chunk/"+chunk_index+"/",data:data,type:"GET",dataType:"html",complete:function(res,status){"success"==status&&onSuccess(res.responseText)}})},getDiffFile:function(review_base_url,filediff_id,filediff_revision,interfilediff_id,interfilediff_revision,file_index,onSuccess){var revision_str=filediff_revision;interfilediff_id&&(revision_str+="-"+interfilediff_revision),$.ajax({type:"GET",url:review_base_url+"diff/"+revision_str+"/fragment/"+filediff_id+"/?index="+file_index+"&"+AJAX_SERIAL,complete:onSuccess})},getErrorString:function(rsp){return 207==rsp.err.code?'The file "'+rsp.file+'" (revision '+rsp.revision+") was not found in the repository":rsp.err.msg},setForm:function(form){this.form=form},save:function(options){var self=this;return options=$.extend(!0,{success:function(){},error:function(){}},options),void 0!=self.id?void options.error("The diff "+self.id+" was already created. This is a script error. Please report it."):self.form?void self.review_request.ready(function(){RB.apiCall({url:self.review_request.links.diffs.href,form:self.form,buttons:options.buttons,success:function(rsp){"ok"==rsp.stat?options.success(rsp):options.error(rsp,rsp.err.msg)}})}):void options.error("No data has been set for this diff. This is a script error. Please report it.")}}),RB.ReviewRequest=function(id,prefix,path){return this.id=id,this.prefix=prefix,this.path=path,this.reviews={},this.draft_review=null,this.links={},this.loaded=!1,this},$.extend(RB.ReviewRequest,{CHECK_UPDATES_MSECS:3e5,CLOSE_DISCARDED:1,CLOSE_SUBMITTED:2}),$.extend(RB.ReviewRequest.prototype,{createDiff:function(revision,interdiff_revision){return new RB.Diff(this,revision,interdiff_revision)},createReview:function(review_id){return void 0==review_id?(null==this.draft_review&&(this.draft_review=new RB.Review(this)),this.draft_review):(this.reviews[review_id]||(this.reviews[review_id]=new RB.Review(this,review_id)),this.reviews[review_id])},createScreenshot:function(screenshot_id){return new RB.Screenshot(this,screenshot_id)},createFileAttachment:function(file_attachment_id){return new RB.FileAttachment(this,file_attachment_id)},ready:function(on_ready){if(this.loaded)on_ready.apply(this,arguments);else{var self=this;this._apiCall({type:"GET",path:"/",success:function(rsp){self.loaded=!0,self.links=rsp.review_request.links,on_ready.apply(this,arguments)}})}},setDraftField:function(options){data={},data[options.field]=options.value,("target_people"===options.field||"target_groups"===options.field||"depends_on"===options.field)&&(data.expand=options.field),this._apiCall({type:"PUT",path:"/draft/",buttons:options.buttons,data:data,success:options.success})},setStarred:function(starred){var apiType,path="/users/"+gUserName+"/watched/review-requests/",data={};starred?(apiType="POST",data.object_id=this.id):(apiType="DELETE",path+=this.id+"/"),RB.apiCall({type:apiType,path:path,data:data,success:function(){}})},publish:function(options){var self=this;options=$.extend(!0,{},options),self.ready(function(){self._apiCall({type:"PUT",url:self.links.draft.href,data:{"public":1},buttons:options.buttons})})},discardDraft:function(options){var self=this;self.ready(function(){self._apiCall({type:"DELETE",url:self.links.draft.href,buttons:options.buttons})})},close:function(options){var statusType,self=this;if(options.type==RB.ReviewRequest.CLOSE_DISCARDED)statusType="discarded";else{if(options.type!=RB.ReviewRequest.CLOSE_SUBMITTED)return;statusType="submitted"}data={status:statusType},void 0!==options.description&&(data.description=options.description),self.ready(function(){self._apiCall({type:"PUT",path:"/",data:data,buttons:options.buttons})})},reopen:function(options){options=$.extend(!0,{},options),this._apiCall({type:"PUT",path:"/",data:{status:"pending"},buttons:options.buttons})},deletePermanently:function(options){options=$.extend(!0,{},options),this._apiCall({type:"DELETE",path:"/",buttons:options.buttons,success:options.success})},markUpdated:function(timestamp){this.lastUpdateTimestamp=timestamp},beginCheckForUpdates:function(type,lastUpdateTimestamp){var self=this;this.checkUpdatesType=type,this.lastUpdateTimestamp=lastUpdateTimestamp,setTimeout(function(){self._checkForUpdates()},RB.ReviewRequest.CHECK_UPDATES_MSECS)},_checkForUpdates:function(){var self=this;self.ready(function(){self._apiCall({type:"GET",noActivityIndicator:!0,url:self.links.last_update.href,success:function(rsp){var last_update=rsp.last_update;void 0!=self.checkUpdatesType&&self.checkUpdatesType!=last_update.type||self.lastUpdateTimestamp==last_update.timestamp||$.event.trigger("updated",[last_update],self),self.lastUpdateTimestamp=last_update.timestamp,setTimeout(function(){self._checkForUpdates()},RB.ReviewRequest.CHECK_UPDATES_MSECS)}})})},_apiCall:function(options){var self=this;options.prefix=this.prefix,options.path="/review-requests/"+this.id+options.path,options.success||(options.success=function(){window.location=self.path}),RB.apiCall(options)}}),RB.Review=function(review_request,id){return this.id=id,this.review_request=review_request,this.draft_reply=null,this.ship_it=null,this.body_top=null,this.body_bottom=null,this.url=null,this.loaded=!1,this["public"]=null,this},$.extend(RB.Review.prototype,{createDiffComment:function(id,filediff,interfilediff,beginLineNum,endLineNum){return new RB.DiffComment(this,id,filediff,interfilediff,beginLineNum,endLineNum)},createScreenshotComment:function(id,screenshot_id,x,y,width,height){return new RB.ScreenshotComment(this,id,screenshot_id,x,y,width,height)},createFileAttachmentComment:function(id,file_attachment_id){return new RB.FileAttachmentComment(this,id,file_attachment_id)},createReply:function(){return null==this.draft_reply&&(this.draft_reply=new RB.ReviewReply(this)),this.draft_reply},ready:function(on_done){this.loaded?on_done.apply(this,arguments):this._load(on_done)},ensureCreated:function(on_done){var self=this;self.ready(function(){self.loaded?on_done.apply(this,arguments):self.save({success:function(rsp){self.id=rsp.review.id,self.loaded=!0,on_done.apply(this,arguments)}})})},save:function(options){var data={};null!=this.ship_it&&(data.ship_it=this.ship_it?1:0),null!=this.body_top&&(data.body_top=this.body_top),null!=this.body_bottom&&(data.body_bottom=this.body_bottom),options["public"]&&(data["public"]=1);var self=this;this.ready(function(){var type,url;self.loaded?(type="PUT",url=self.url):(type="POST",url=self.review_request.links.reviews.href),self._apiCall({type:type,url:url,data:data,buttons:options.buttons,success:function(rsp){self._loadDataFromResponse(rsp),$.isFunction(options.success)&&options.success(rsp)}})})},publish:function(options){this.save($.extend(!0,{"public":!0},options))},deleteReview:function(options){var self=this;self.ready(function(){self.loaded?self._apiCall({type:"DELETE",buttons:options.buttons,success:options.success}):$.isFunction(options.success)&&options.success()})},_load:function(on_done){var self=this;self.review_request.ready(function(){RB.apiCall({type:"GET",url:self.review_request.links.reviews.href+(self.id||"draft")+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}})})},_loadDataFromResponse:function(rsp){this.id=rsp.review.id,this.ship_it=rsp.review.ship_it,this.body_top=rsp.review.body_top,this.body_bottom=rsp.review.body_bottom,this.links=rsp.review.links,this.url=rsp.review.links.self.href,this.loaded=!0,this["public"]=rsp.review["public"]},_apiCall:function(options){var self=this;self.review_request.ready(function(){options.url||(options.url=self.review_request.links.reviews.href+self.id+"/"+(options.path||"")),options.success||(options.success=function(){window.location=self.review_request.path}),RB.apiCall(options)})}}),RB.ReviewGroup=function(id){return this.id=id,this},$.extend(RB.ReviewGroup.prototype,{setStarred:function(starred){var apiType,path="/users/"+gUserName+"/watched/review-groups/",data={};starred?(apiType="POST",data.object_id=this.id):(apiType="DELETE",path+=this.id+"/"),RB.apiCall({type:apiType,path:path,data:data,success:function(){}})}}),RB.ReviewReply=function(review,id){return this.review=review,this.id=id,this.body_top=null,this.body_bottom=null,this.url=null,this.loaded=!1,this},$.extend(RB.ReviewReply.prototype,{ready:function(on_done){this.loaded?on_done.apply(this,arguments):this._load(on_done)},ensureCreated:function(on_done){var self=this;self.ready(function(){self.loaded?on_done.apply(this,arguments):self.save({success:function(rsp){self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}})})},save:function(options){var data={};null!=this.body_top&&(data.body_top=this.body_top),null!=this.body_bottom&&(data.body_bottom=this.body_bottom),options["public"]&&(data["public"]=1);var self=this;this.ready(function(){var type,url;self.loaded?(type="PUT",url=self.url):(type="POST",url=self.review.links.replies.href),RB.apiCall({type:type,url:url,data:data,buttons:options.buttons,success:function(rsp){self._loadDataFromResponse(rsp),$.isFunction(options.success)&&options.success(rsp)}})})},publish:function(options){this.save($.extend(!0,{"public":!0,errorText:"Saving the reply draft has failed due to a server error:"},options))},discard:function(options){var self=this;self.ready(function(){self.loaded?RB.apiCall($.extend(!0,options,{url:self.url,type:"DELETE",errorText:"Discarding the reply draft has failed due to a server error:"})):$.isFunction(options.success)&&options.success()})},discardIfEmpty:function(options){var self=this;self.ready(function(){!this.id||self.body_top||self.body_bottom||RB.apiCall({type:"GET",url:self.links.diff_comments.href,success:function(rsp){0==rsp.diff_comments.length&&RB.apiCall({type:"GET",url:self.links.screenshot_comments.href,success:function(rsp){0==rsp.screenshot_comments.length&&self.discard(options)}})}})})},_load:function(on_done){var self=this;self.review.ready(function(){RB.apiCall({type:"GET",url:self.review.links.replies.href+(self.id?self.id:"draft")+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}})})},_loadDataFromResponse:function(rsp){this.id=rsp.reply.id,this.body_top=rsp.reply.body_top,this.body_bottom=rsp.reply.body_bottom,this.links=rsp.reply.links,this.url=rsp.reply.links.self.href,this.loaded=!0}}),RB.FileAttachment=function(review_request,id){return this.review_request=review_request,this.id=id,this.caption=null,this.thumbnail=null,this.path=null,this.url=null,this.loaded=!1,this},$.extend(RB.FileAttachment.prototype,{setFile:function(file){this.file=file},setForm:function(form){this.form=form},ready:function(on_done){this.loaded&&this.id?on_done.apply(this,arguments):this._load(on_done)},save:function(options){if(options=$.extend(!0,{success:function(){},error:function(){}},options),this.id){var data={};null!=this.caption&&(data.caption=this.caption);var self=this;this.ready(function(){RB.apiCall({type:"PUT",url:self.url,data:data,buttons:options.buttons,success:function(rsp){self._loadDataFromResponse(rsp),$.isFunction(options.success)&&options.success(rsp)}})})}else this.form?this._saveForm(options):this.file?this._saveFile(options):options.error("No data has been set for this file. This is a script error. Please report it.")},deleteFileAttachment:function(){var self=this;self.ready(function(){self.loaded&&RB.apiCall({type:"DELETE",url:self.url,success:function(){$.event.trigger("deleted",null,self),self._deleteAndDestruct()}})})},_load:function(on_done){if(!this.id)return void on_done.apply(this,arguments);var self=this;self.review_request.ready(function(){RB.apiCall({type:"GET",url:self.review_request.links.file_attachments.href+self.id+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}})})},_loadDataFromResponse:function(rsp){this.id=rsp.file_attachment.id,this.caption=rsp.file_attachment.caption,this.thumbnail=rsp.file_attachment.thumbnail,this.path=rsp.file_attachment.path,this.url=rsp.file_attachment.links.self.href,this.loaded=!0},_saveForm:function(options){this._saveApiCall(options.success,options.error,{buttons:options.buttons,form:this.form})},_saveFile:function(options){sendFileBlob(this.file,this._saveApiCall,this,options)},_saveApiCall:function(onSuccess,onError,options){var self=this;self.review_request.ready(function(){RB.apiCall($.extend(options,{url:self.review_request.links.file_attachments.href,success:function(rsp){"ok"==rsp.stat?(self._loadDataFromResponse(rsp),$.isFunction(onSuccess)&&onSuccess(rsp,rsp.file_attachment)):$.isFunction(onError)&&onError(rsp,rsp.err.msg)}}))})},_deleteAndDestruct:function(){$.event.trigger("destroyed",null,this)}}),RB.FileAttachmentCommentReply=function(reply,id,reply_to_id){return this.id=id,this.reply=reply,this.text="",this.reply_to_id=reply_to_id,this.loaded=!1,this.url=null,this},$.extend(RB.FileAttachmentCommentReply.prototype,{ready:function(on_ready){this.loaded?on_ready.apply(this,arguments):this._load(on_ready)},setText:function(text){this.text=text,$.event.trigger("textChanged",null,this)},save:function(options){var self=this;options=options||{},self.ready(function(){self.reply.ensureCreated(function(){var type,url,data={text:self.text};self.loaded?(type="PUT",url=self.url):(data.reply_to_id=self.reply_to_id,url=self.reply.links.file_attachment_comments.href),RB.apiCall({type:type,url:url,data:data,success:function(rsp){self._loadDataFromResponse(rsp),$.event.trigger("saved",null,self),$.isFunction(options.success)&&options.success()}})})})},deleteComment:function(){var self=this;self.ready(function(){self.loaded?RB.apiCall({type:"DELETE",url:self.url,success:function(){$.event.trigger("deleted",null,self),self._deleteAndDestruct()}}):self._deleteAndDestruct()})},deleteIfEmpty:function(){""==this.text&&this.deleteComment()},_deleteAndDestruct:function(){$.event.trigger("destroyed",null,this)},_load:function(on_done){var self=this;return self.id?void self.reply.ready(function(){return self.reply.loaded?void RB.apiCall({type:"GET",url:self.reply.links.file_attachment_comments.href+self.id+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}}):void on_done.apply(this,arguments)}):void on_done.apply(this,arguments)},_loadDataFromResponse:function(rsp){this.id=rsp.file_attachment_comment.id,this.text=rsp.file_attachment_comment.text,this.links=rsp.file_attachment_comment.links,this.url=rsp.file_attachment_comment.links.self.href,this.loaded=!0}}),RB.Screenshot=function(review_request,id){return this.review_request=review_request,this.id=id,this.caption=null,this.thumbnail_url=null,this.path=null,this.url=null,this.loaded=!1,this},$.extend(RB.Screenshot.prototype,{setFile:function(file){this.file=file},setForm:function(form){this.form=form},ready:function(on_done){this.loaded&&this.id?on_done.apply(this,arguments):this._load(on_done)},save:function(options){if(options=$.extend(!0,{success:function(){},error:function(){}},options),this.id){var data={};null!=this.caption&&(data.caption=this.caption);var self=this;this.ready(function(){RB.apiCall({type:"PUT",url:self.url,data:data,buttons:options.buttons,success:function(rsp){self._loadDataFromResponse(rsp),$.isFunction(options.success)&&options.success(rsp)}})})}else this.form?this._saveForm(options):this.file?this._saveFile(options):options.error("No data has been set for this screenshot. This is a script error. Please report it.")},deleteScreenshot:function(){var self=this;self.ready(function(){self.loaded&&RB.apiCall({type:"DELETE",url:self.url,success:function(){$.event.trigger("deleted",null,self),self._deleteAndDestruct()}})})},_load:function(on_done){if(!this.id)return void on_done.apply(this,arguments);var self=this;self.review_request.ready(function(){RB.apiCall({type:"GET",url:self.review_request.links.screenshots.href+self.id+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}})})},_loadDataFromResponse:function(rsp){this.id=rsp.screenshot.id,this.caption=rsp.screenshot.caption,this.thumbnail_url=rsp.screenshot.thumbnail_url,this.path=rsp.screenshot.path,this.url=rsp.screenshot.links.self.href,this.loaded=!0},_saveForm:function(options){this._saveApiCall(options.success,options.error,{buttons:options.buttons,form:this.form})},_saveFile:function(options){sendFileBlob(this.file,this._saveApiCall,this,options)},_saveApiCall:function(onSuccess,onError,options){var self=this;self.review_request.ready(function(){RB.apiCall($.extend(options,{url:self.review_request.links.screenshots.href,success:function(rsp){"ok"==rsp.stat?(self._loadDataFromResponse(rsp),$.isFunction(onSuccess)&&onSuccess(rsp,rsp.screenshot)):$.isFunction(onError)&&onError(rsp,rsp.err.msg)}}))})},_deleteAndDestruct:function(){$.event.trigger("destroyed",null,this)}}),RB.ScreenshotComment=function(review,id,screenshot_id,x,y,width,height){return this.id=id,this.review=review,this.screenshot_id=screenshot_id,this.x=x,this.y=y,this.width=width,this.height=height,this.text="",this.issue_opened=!0,this.issue_status="",this.loaded=!1,this.url=null,this},$.extend(RB.ScreenshotComment.prototype,{ready:function(on_ready){this.loaded?on_ready.apply(this,arguments):this._load(on_ready)},setText:function(text){this.text=text,$.event.trigger("textChanged",null,this)},save:function(options){var self=this;options=$.extend({success:function(){}},options),self.ready(function(){self.review.ensureCreated(function(){var type,url,data={text:self.text,x:self.x,y:self.y,w:self.width,h:self.height,issue_opened:self.issue_opened};self.loaded?(type="PUT",url=self.url,self.review["public"]&&(data.issue_status=self.issue_status)):(data.screenshot_id=self.screenshot_id,url=self.review.links.screenshot_comments.href),RB.apiCall({type:type,url:url,data:data,success:function(rsp){self._loadDataFromResponse(rsp),$.event.trigger("saved",null,self),options.success(rsp)}})})})},deleteComment:function(){var self=this;self.ready(function(){self.loaded?RB.apiCall({type:"DELETE",url:self.url,success:function(){$.event.trigger("deleted",null,self),self._deleteAndDestruct()}}):self._deleteAndDestruct()})},deleteIfEmpty:function(){""==this.text&&this.deleteComment()},_deleteAndDestruct:function(){$.event.trigger("destroyed",null,this)},_load:function(on_done){var self=this;return self.id?void self.review.ready(function(){return self.review.loaded?void RB.apiCall({type:"GET",url:self.review.links.screenshot_comments.href+self.id+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}}):void on_done.apply(this,arguments)}):void on_done.apply(this,arguments)},_loadDataFromResponse:function(rsp){this.id=rsp.screenshot_comment.id,this.text=rsp.screenshot_comment.text,this.x=rsp.screenshot_comment.x,this.y=rsp.screenshot_comment.y,this.width=rsp.screenshot_comment.w,this.height=rsp.screenshot_comment.h,this.links=rsp.screenshot_comment.links,this.url=rsp.screenshot_comment.links.self.href,this.loaded=!0,this.issue_opened=rsp.screenshot_comment.issue_opened,this.issue_status=rsp.screenshot_comment.issue_status}}),RB.FileAttachmentComment=function(review,id,file_attachment_id){return this.id=id,this.review=review,this.file_attachment_id=file_attachment_id,this.text="",this.loaded=!1,this.issue_opened=!0,this.issue_status="",this.url=null,this.extra_data={},this},$.extend(RB.FileAttachmentComment.prototype,{ready:function(on_ready){this.loaded?on_ready.apply(this,arguments):this._load(on_ready)},setText:function(text){this.text=text,$.event.trigger("textChanged",null,this)},setForm:function(form){this.form=form},_saveForm:function(options){this._saveApiCall(options.success,options.error,{buttons:options.buttons,form:this.form})},save:function(options){var self=this;options=$.extend({success:function(){}},options),self.ready(function(){self.review.ensureCreated(function(){var type,url,data={text:self.text,
issue_opened:self.issue_opened};_.each(self.extra_data,function(value,key){data["extra_data."+key]=value},this),self.loaded?(type="PUT",url=self.url,self.review["public"]&&(data.issue_status=self.issue_status)):(data.file_attachment_id=self.file_attachment_id,url=self.review.links.file_attachment_comments.href),RB.apiCall({type:type,url:url,data:data,success:function(rsp){self._loadDataFromResponse(rsp),$.event.trigger("saved",null,self),$.isFunction(options.success)&&options.success(rsp)}})})})},deleteComment:function(){var self=this;self.ready(function(){self.loaded?RB.apiCall({type:"DELETE",url:self.url,success:function(){$.event.trigger("deleted",null,self),self._deleteAndDestruct()}}):self._deleteAndDestruct()})},deleteIfEmpty:function(){""==this.text&&this.deleteComment()},_deleteAndDestruct:function(){$.event.trigger("destroyed",null,this)},_load:function(on_done){var self=this;return self.id?void self.review.ready(function(){return self.review.loaded?void RB.apiCall({type:"GET",url:self.review.links.file_attachment_comments.href+self.id+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}}):void on_done.apply(this,arguments)}):void on_done.apply(this,arguments)},_loadDataFromResponse:function(rsp){this.id=rsp.file_attachment_comment.id,this.text=rsp.file_attachment_comment.text,this.links=rsp.file_attachment_comment.links,this.url=rsp.file_attachment_comment.links.self.href,this.issue_opened=rsp.file_attachment_comment.issue_opened,this.issue_status=rsp.file_attachment_comment.issue_status,this.extra_data=rsp.file_attachment_comment.extra_data,this.loaded=!0}}),RB.ScreenshotCommentReply=function(reply,id,reply_to_id){return this.id=id,this.reply=reply,this.text="",this.reply_to_id=reply_to_id,this.loaded=!1,this.url=null,this},$.extend(RB.ScreenshotCommentReply.prototype,{ready:function(on_ready){this.loaded?on_ready.apply(this,arguments):this._load(on_ready)},setText:function(text){this.text=text,$.event.trigger("textChanged",null,this)},save:function(options){var self=this;options=options||{},self.ready(function(){self.reply.ensureCreated(function(){var type,url,data={text:self.text};self.loaded?(type="PUT",url=self.url):(data.reply_to_id=self.reply_to_id,url=self.reply.links.screenshot_comments.href),RB.apiCall({type:type,url:url,data:data,success:function(rsp){self._loadDataFromResponse(rsp),$.event.trigger("saved",null,self),$.isFunction(options.success)&&options.success()}})})})},deleteComment:function(){var self=this;self.ready(function(){self.loaded?RB.apiCall({type:"DELETE",url:self.url,success:function(){$.event.trigger("deleted",null,self),self._deleteAndDestruct()}}):self._deleteAndDestruct()})},deleteIfEmpty:function(){""==this.text&&this.deleteComment()},_deleteAndDestruct:function(){$.event.trigger("destroyed",null,this)},_load:function(on_done){var self=this;return self.id?void self.reply.ready(function(){return self.reply.loaded?void RB.apiCall({type:"GET",url:self.reply.links.screenshot_comments.href+self.id+"/",success:function(rsp,status){404!=status&&self._loadDataFromResponse(rsp),on_done.apply(this,arguments)}}):void on_done.apply(this,arguments)}):void on_done.apply(this,arguments)},_loadDataFromResponse:function(rsp){this.id=rsp.screenshot_comment.id,this.text=rsp.screenshot_comment.text,this.links=rsp.screenshot_comment.links,this.url=rsp.screenshot_comment.links.self.href,this.loaded=!0}}),RB.apiCall=function(options){function doCall(){options.buttons&&options.buttons.attr("disabled",!0);var activityIndicator=$("#activity-indicator");options.noActivityIndicator||activityIndicator.removeClass("error").text(options.type||"GET"==options.type?"Loading...":"Saving...").show();var data=$.extend(!0,{url:url,data:options.data,dataType:options.dataType||"json",error:function(xhr,textStatus,errorThrown){var rsp=null;try{rsp=$.parseJSON(xhr.responseText)}catch(e){}if(rsp&&rsp.stat||204==xhr.status)return void($.isFunction(options.success)&&options.success(rsp,xhr.status));var responseText=xhr.responseText;activityIndicator.addClass("error").text("A server error occurred.").append($("<a/>").text("Show Details").attr("href","#").click(function(){showErrorPage(xhr,responseText)})).append($("<a/>").text("Dismiss").attr("href","#").click(function(){return activityIndicator.fadeOut("fast"),!1})),$.isFunction(options.error)&&options.error(xhr,textStatus,errorThrown)}},options);data.complete=function(xhr,status){options.buttons&&options.buttons.attr("disabled",!1),options.noActivityIndicator||activityIndicator.hasClass("error")||activityIndicator.delay(1e3).fadeOut("fast"),$.isFunction(options.complete)&&options.complete(xhr,status),$.funcQueue("rbapicall").next()},(null==data.data||void 0==data.data||"object"==typeof data.data)&&(data.data=$.extend({api_format:"json"},data.data||{})),options.form?options.form.ajaxSubmit(data):$.ajax(data)}function showErrorPage(xhr,data){var iframe=$("<iframe/>").width("100%"),requestData="(none)";options.data&&(requestData=$.param(options.data));var doc=($('<div class="server-error-box"/>').appendTo("body").append("<p><b>Error Code:</b> "+xhr.status+"</p>").append("<p><b>Error Text:</b> "+xhr.statusText+"</p>").append("<p><b>Request URL:</b> "+url+"</p>").append("<p><b>Request Data:</b> "+requestData+"</p>").append('<p class="response-data"><b>Response Data:</b></p>').append('<p>There may be useful error details below. The following error page may be useful to your system administrator or when <a href="https://www.reviewboard.org/bugs/new/">reporting a bug</a>. To save the page, right-click the error below and choose "Save Page As," if available, or "View Source" and save the result as a <tt>.html</tt> file.</p>').append("<p><b>Warning:</b> Be sure to remove any sensitive material that may exist in the error page before reporting a bug!</p>").append(iframe).on("resize",function(){iframe.height($(this).height()-iframe.position().top)}).modalBox({stretchX:!0,stretchY:!0,title:"Server Error Details"}),iframe[0].contentDocument||iframe[0].contentWindow.document);doc.open(),doc.write(data),doc.close()}var prefix=options.prefix||"",url=options.url||SITE_ROOT+prefix+"api"+options.path;options.type=options.type||"POST","GET"!=options.type?($.funcQueue("rbapicall").add(doCall),$.funcQueue("rbapicall").start()):doCall()},XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(datastr){var data=new Uint8Array(Array.prototype.map.call(datastr,function(x){return 255&x.charCodeAt(0)}));XMLHttpRequest.prototype.send.call(this,data.buffer)})}).call(this);