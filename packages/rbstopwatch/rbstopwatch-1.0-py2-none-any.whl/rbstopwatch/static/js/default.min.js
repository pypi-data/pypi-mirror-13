(function(){RBStopwatch={};RBStopwatch.formatTimeString=function(totalSeconds){var hours=Math.floor(totalSeconds/3600).toFixed(0),minutes=Math.floor(totalSeconds%3600/60).toFixed(0),seconds=Math.floor(totalSeconds%60).toFixed(0),display;display=hours<10?"0"+hours:hours;display+=":";display+=minutes<10?"0"+minutes:minutes;display+=":";display+=seconds<10?"0"+seconds:seconds;return display};RBStopwatch.Stopwatch=Backbone.Model.extend({defaults:{pendingReview:null,timerOn:false,totalSec:0},initialize:function(attributes){var extraData,currentTime,pendingReview=attributes.pendingReview;_.bindAll(this,"toggle","_onReviewDone","_onTick");_super(this).initialize.apply(this,arguments);this._startTime=null;this._timerHandle=null;console.assert(pendingReview);extraData=pendingReview.get("extraData")||{};currentTime=parseInt(extraData["rbstopwatch.reviewTime"],10)||0;this.set("totalSec",currentTime);this._currentTime=currentTime;this.listenTo(pendingReview,"destroy",this._onReviewDone);this.listenTo(pendingReview,"publishing",this._onReviewDone)},toggle:function(){if(this._timerHandle){this._stop()}else{this._start()}},_start:function(){console.assert(this._timerHandle===null);this._startTime=Date.now();this._timerHandle=window.setInterval(this._onTick,1e3);this.set("timerOn",true)},_stop:function(options){var addedTime,pendingReview,extraData;options=options||{};console.assert(this._timerHandle!==null);console.assert(this._startTime!==null);window.clearInterval(this._timerHandle);this._timerHandle=null;addedTime=Math.floor((Date.now()-this._startTime)/1e3);this._currentTime+=addedTime;this.set({totalSec:this._currentTime,timerOn:false});pendingReview=this.get("pendingReview");extraData=pendingReview.get("extraData");extraData["rbstopwatch.reviewTime"]=this._currentTime;pendingReview.set("extraData",extraData);if(options.skipSave!==true){pendingReview.save();RB.DraftReviewBannerView.instance.show()}},_onReviewDone:function(){if(this.get("timerOn")){this._stop({skipSave:true})}},_onTick:function(){var addedTime;console.assert(this._startTime!==null);addedTime=Math.floor((Date.now()-this._startTime)/1e3);this.set("totalSec",this._currentTime+addedTime)}},{instance:null,create:function(options){if(!this.instance){this.instance=new RBStopwatch.Stopwatch(options)}return this.instance}});RBStopwatch.StopwatchView=Backbone.View.extend({id:"rbstopwatch-stopwatch",template:_.template(['<div class="<%= stopwatchClass %>">'," &#x1F551;<%= display %>","</div>"].join("")),events:{click:"toggle"},initialize:function(){this.listenTo(this.model,"change",this.render);window.addEventListener("beforeunload",_.bind(this.beforeUnload,this))},render:function(){var totalSec=this.model.get("totalSec"),timerOn=this.model.get("timerOn"),display=RBStopwatch.formatTimeString(totalSec);this.$el.html(this.template({display:display,stopwatchClass:timerOn?"rbstopwatch-on":"rbstopwatch-off"}));return this},toggle:function(){this.model.toggle()},beforeUnload:function(ev){var message;if(this.model.get("timerOn")){message="The review stopwatch is still running. If you leave "+"without stopping it, the timer info for this page "+"will be lost.";(ev||window.event).returnValue=message;return message}return null}});RBStopwatch.ReviewDialogHookView=Backbone.View.extend({template:_.template(["<%- prefixText %> ",'<span class="<%- className %>"><%- timeText %></div>'].join("")),initialize:function(){var stopwatch=RBStopwatch.Stopwatch.instance;if(stopwatch){this.listenTo(stopwatch,"change",this.render)}},render:function(){var stopwatch=RBStopwatch.Stopwatch.instance,extraData,currentTime,timerOn=false;if(stopwatch){timerOn=stopwatch.get("timerOn");currentTime=stopwatch.get("totalSec")}else{extraData=this.model.get("extraData")||{};currentTime=parseInt(extraData["rbstopwatch.reviewTime"],10)||0}if(currentTime){this.$el.html(this.template({className:timerOn?"rbstopwatch-on":"rbstopwatch-off",prefixText:gettext("Total time spent on this review:"),timeText:RBStopwatch.formatTimeString(currentTime)}))}else{this.$el.empty()}return this}});RBStopwatch.Extension=RB.Extension.extend({initialize:function(){var reviewDialogHook;_super(this).initialize.call(this);reviewDialogHook=new RB.ReviewDialogHook({extension:this,viewType:RBStopwatch.ReviewDialogHookView});RB.PageManager.ready(function(page){var pendingReview=page.pendingReview;pendingReview.ready({ready:function(){this.stopwatchView=new RBStopwatch.StopwatchView({model:RBStopwatch.Stopwatch.create({pendingReview:pendingReview})});this.stopwatchView.render();$("body").append(this.stopwatchView.$el)}},this)},this)}})}).call(this);
