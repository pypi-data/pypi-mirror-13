(function(){$(function(){var Type,TypeView,TypeCollection,TypeCollectionView,$commentTypes=$("#id_types"),view;Type=Backbone.Model.extend({defaults:{type:"",visible:true}});TypeView=Backbone.View.extend({tagName:"tr",events:{"click #rbcommenttype-remove":"_remove","change #rbcommenttype-visible":"_onVisibleChanged","change #rbcommenttype-type":"_onTypeChanged"},template:_.template(["<td>",' <input id="rbcommenttype-visible" type="checkbox"',"        <% if (visible) { %>checked<% } %>/>","</td>","<td>",' <input id="rbcommenttype-type" value="<%- type %>"','        size="40" />',"</td>","<td>",' <a href="#" id="rbcommenttype-remove">','  <span class="rb-icon rb-icon-remove-widget"></span>'," </a>","</td>"].join("")),render:function(){this.$el.html(this.template(this.model.attributes));return this},_remove:function(){this.model.destroy()},_onVisibleChanged:function(ev){this.model.set("visible",$(ev.target).prop("checked"))},_onTypeChanged:function(ev){this.model.set("type",$(ev.target).val())}});TypeCollection=Backbone.Collection.extend({model:Type,initialize:function(models,options){this._$input=options.$input;this.add(JSON.parse(this._$input.val()||"[]"));this.listenTo(this,"add remove change",this._onChange)},_onChange:function(){this._$input.val(JSON.stringify(this))}});TypeCollectionView=Backbone.View.extend({tagName:"table",className:"comment-types",template:_.template(["<thead>"," <tr>","  <td>Visible</td>","  <td>Comment Type</td>","  <td></td>"," </tr>","</thead>","<tbody>","</tbody>","<tfoot>"," <tr>",'  <td colspan="4">','   <a href="#" id="rbcommenttype-add-type">Add type</a>',"  </td>"," </tr>","</tfoot>"].join("")),events:{"click #rbcommenttype-add-type":"_addType"},initialize:function(){this._views=[];this._rendered=false;_.bindAll(this,"add","remove");this.collection.each(this.add);this.listenTo(this.collection,"add",this.add);this.listenTo(this.collection,"remove",this.remove)},add:function(type){var view=new TypeView({model:type});this._views.push(view);if(this._rendered){this.$("tbody").append(view.render().$el)}},remove:function(type){var view=_.select(this._views,function(v){return v.model==type})[0];this._views=_.without(this._views,view);if(this._rendered){view.$el.remove()}},render:function(){var $tbody;this._rendered=true;this.$el.html(this.template());$tbody=this.$("tbody");_.each(this._views,function(view){$tbody.append(view.render().$el)});return this},_addType:function(){this.collection.add(new Type);this._views[this._views.length-1].$("input").focus();return false}});view=new TypeCollectionView({collection:new TypeCollection(null,{$input:$commentTypes})});$commentTypes.after(view.render().$el)})}).call(this);
