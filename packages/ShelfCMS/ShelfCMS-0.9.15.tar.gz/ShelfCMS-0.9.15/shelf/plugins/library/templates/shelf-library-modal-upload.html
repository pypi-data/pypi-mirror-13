<div class="modal-dialog modalBiblio--uploader">
    <div class="modal-content" style='border-radius: 0px'>
        <div class="modal-header">
            <button aria-hidden="true" data-dismiss="modal" class="close" type="button"><i class="fa fa-times fa-lg"></i></button>
            <h1 class="modalBiblio--title">{{ _gettext("File upload") }}</h1>
            <div class="modalBiblio--arborescence">
                <span>{{ _gettext("Root") }}</span><span>{{ dir_path }}</span>
            </div>
        </div>
        {% if dir_path %}
        <a class="modalBiblio--backParent link" href="{{ get_dir_url('.modal_index', parent_path)|safe }}"><i class="fa fa-arrow-circle-o-left"></i>Dossier parent</a>
        {% endif %}
        <div class="modal-body"  style="padding: 0px; overflow: hidden">
            <div class="model-list">
                <form role="form" method="post" enctype="multipart/form-data" id="dropfile" class="modalBiblio--zonedrop">
                    <span style="width:50%">
                    <button type="button" class="btn btn-default" id="upload">{{ _("Select...") }} <i class="fa fa-upload"></i></button>
                    <br>{{ _("Drop your files in the grayed area or select them from your computer") }}</span>
                    <input type="file" name="upload" id="upload" size="chars" style="visibility:hidden;">
                    <input type="hidden" name="async" id="async" value="">
                </form>
                
                <div class="modalBiblio--queue">
                    <div class="modalBiblio--queue-fichier actif hide" id="example-file">
                        <span class="nom"><i class="fa fa-picture-o"></i> <span class="title">-</span><span class="detail"><!--(taille)--></span></span>
                        <a class="del"><i class="fa fa-plus-circle"></i></a>
                        <div class="clear"></div>
                        <div class="progress ">
                            <div style="width: 20%" aria-valuemax="100" aria-valuemin="0" aria-valuenow="0" role="progressbar" class="progress-bar progress-bar-warning">
                                <span class="sr-only">0% complete</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <ul style="float: left; display: inline-block" class="nav nav-pills nav-justified">
                <li>
                    {% if dir_path %}
                        <a class="link" href="{{ url_for('.modal_iconic_index', path=dir_path) }}"><i class="fa fa-th-large"></i></a>
                    {% else %}
                        <a class="link" href="{{ url_for('.modal_iconic_index') }}"><i class="fa fa-th-large"></i></a>
                    {% endif %}
                </li>
                <li>
                    <a class="link" href="#"><i class="fa fa-plus-circle"></i></a>
                </li>
                <li>
                    {% if dir_path %}
                        <a class="link" href="{{ url_for('.modal_upload', path=dir_path) }}"><i class="fa fa-upload"></i></a>
                    {% else %}
                        <a class="link" href="{{ url_for('.modal_upload') }}"><i class="fa fa-upload"></i></a>
                    {% endif %}
                </li>
                <li>
                    <a class="link" href="#"><i class="fa fa-search"></i></a>
                </li>
                <li class="actions validate disabled">
                    <a href="javascript:void(0)">Validate <i class="fa fa-check"></i></a>
                </li>
            </ul>
        </div>
    </div> 
</div>

<script>
$(function() {
    $('a.link').click(function() {
        $(this).closest('.modal').load($(this).attr('href'));
        return false;
    });
    
    var documents = [] // 1 elem au format {'file', 'path', 'size', 'uploaded', 'extension', 'el'}
    
    function updateProgressBar(el, loaded, total)
    {
        var percent = (loaded * 100.0) / total;
        
        progress_container = el.find('.progress').first();
        progress_bar = el.find('.progress-bar').first();
        check_icon = el.find('a.del i').first();
        
        progress_bar.width(percent+'%');
        progress_bar.attr({'aria-valuenow': loaded, 'aria-valuemax': total});
        progress_bar.addClass('progress-bar-success');
        
        if (loaded == total) {
            check_icon.removeClass('fa-times');
            check_icon.addClass('fa-check');
            progress_container.removeClass('active');
            progress_container.removeClass('progress-striped');
        }
        else {
            check_icon.addClass('fa-times');
            check_icon.removeClass('fa-check');
            progress_container.addClass('active');
            progress_container.addClass('progress-striped');
        }
        
        var total = 0;
        var loaded = 0;
        
        for (var i in documents)
        {
            total += documents[i]['size'];
            loaded += documents[i]['uploaded'];
        }
        
        if (total > 0 && loaded == total) {
            validate()
        }
    }

    function upload(files) {
        for (var j=0; j < files.length; j++)
        {
            // Only process image files.
            /*if (!f.type.match('image/jpeg')) {
               alert('The file must be a jpeg image') ;
               return false ;
            }*/
            
            var reader = new FileReader();
            var f = files[j];
            
            var item = $('#example-file').html();
            $('#files-list').prepend(item);
            var el = $('.modalBiblio--queue .modalBiblio--queue-fichier').first();
            el.find('.title').html(f.name);
            
            documents.push({
                'file': f.name,
                'size': f.size,
                'uploaded': 0,
                'type': f.type,
                'el': el
            });
            
            reader.onload = (function(f) {
                return function (evt) {
                    var pic = {};
                    pic.file = evt.target.result.split(',')[1];
                    pic.path = "{{ dir_path }}";
                    pic.name = f.name;
                    //pic.filename = evt.target.result.split(',')[0];
                    
                    var str = jQuery.param(pic);
                    var total_upload_size = 0;
                    
                    $.ajax({
                        type: 'POST',
                        url: '{{ url_for(".async_upload") }}',
                        data: str,
                        xhr: function() {
                            var xhr = new window.XMLHttpRequest();
                            xhr.upload.addEventListener("progress", function(e) {
                                if (!e.lengthComputable) {
                                    return;
                                }
                                
                                for (var i in documents)
                                {
                                    if (documents[i]['file'] == f.name)
                                    {                       
                                        documents[i]['uploaded'] = e.loaded;
                                        documents[i]['size'] = e.total;
                                        updateProgressBar(documents[i]['el'], documents[i]['uploaded'], documents[i]['size']);
                                        break;
                                    }
                                }
                            }, false);
                            
                            return xhr;
                        },
                        success: function(data) {
                            for (var i in documents)
                            {
                                if (documents[i]['file'] == f.name)
                                {
                                    documents[i]['uploaded'] = documents[i]['size'];
                                    updateProgressBar(documents[i]['el'], documents[i]['uploaded'], documents[i]['size']);
                                    break;
                                }
                            }
                        }
                    });
                };
            })(files[j]);
          
            reader.readAsDataURL(f);
        }
    }
    
    function validate() {
        var finished = [];
        for (var i=0; i < documents.length; i++)
        {
            if (documents[i]['size'] == documents[i]['uploaded'])
            {
                finished.push(documents[i].file);
            }
        }
        $("input#async").val(JSON.stringify(finished));
        $('#dropfile').submit();
    }
    
    $(document).on('dragenter', '#dropfile', function() {
        $(this).css('background-color', 'green');
        return false;
    });
    
    $(document).on('dragover', '#dropfile', function(e){
        e.preventDefault();
        e.stopPropagation();
        $(this).css('background-color', 'green');
        return false;
    });
    
    $(document).on('dragleave', '#dropfile', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).css('background-color', 'black');
        return false;
    });
    
    $('#upload').click(function(e) {
        $('#jquery_file_fake_selector').click();
        $('#jquery_file_fake_selector').one('change', function() {
            upload(this.files);
            $(this).val('');
        });
    });
    
    $('li.actions.validate').on('click', validate);
    
    $(document).on('drop', '#dropfile', function(e) {
        if(e.originalEvent.dataTransfer){
            if(e.originalEvent.dataTransfer.files.length) {
                // Stop the propagation of the event
                e.preventDefault();
                e.stopPropagation();
                $(this).css('background-color', 'black');
                
                // Main function to upload
                upload(e.originalEvent.dataTransfer.files);
            }
        }
        else
        {
            $(this).css('background-color', 'black');
        }
        return false;
    });    
});
</script>